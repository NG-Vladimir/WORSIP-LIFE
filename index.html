<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Worship Pro Classic Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --p: #4f46e5; --bg: #f8fafc; --c: #ffffff; --t: #0f172a; --m: #64748b; --d: #ef4444; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: var(--t); padding-bottom: 80px; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 24px; font-weight: bold; }
        .card { background: var(--c); border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; position: relative; }
        .btn-add { background: var(--p); color: white; border: none; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px; font-size: 16px; background: #fff; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: var(--m); }
        .btn-submit { width: 100%; padding: 15px; background: var(--p); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .tag { display: inline-block; padding: 4px 8px; background: #eee; border-radius: 4px; font-size: 12px; margin: 2px; }
        .leader-info { font-weight: bold; color: var(--p); margin-bottom: 5px; display: block; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; padding: 20px; overflow-y: auto; }
        .nav { position: fixed; bottom: 0; width: 100%; max-width: 500px; background: #fff; border-top: 1px solid #ddd; display: flex; padding: 10px 0; }
        .nav-item { border: none; background: none; color: var(--m); flex: 1; display: flex; flex-direction: column; align-items: center; font-size: 12px; }
        .nav-item.active { color: var(--p); }
        .song-picker-box { border: 1px solid #ddd; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; }
        .song-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .song-item.selected { background: #eef2ff; color: var(--p); font-weight: bold; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: var(--p); display: none; z-index: 1000; }
    </style>
</head>
<body>

<div id="loader"></div>

<div class="container">
    <section id="schedule" class="screen active">
        <div class="header"><h1>–ì—Ä–∞—Ñ–∏–∫</h1><button class="btn-add" onclick="openServiceForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-services">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </section>

    <section id="songs" class="screen">
        <div class="header"><h1>–ü–µ—Å–Ω–∏</h1></div>
        <div id="list-folders"></div>
    </section>

    <section id="team" class="screen">
        <div class="header"><h1>–ö–æ–º–∞–Ω–¥–∞</h1><button class="btn-add" onclick="openMemberForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-team"></div>
    </section>

    <div id="modal">
        <div class="header"><h2 id="modal-title"></h2><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
        <div id="modal-content"></div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="switchTab('schedule')"><i data-lucide="calendar"></i>–ì—Ä–∞—Ñ–∏–∫</button>
        <button class="nav-item" onclick="switchTab('songs')"><i data-lucide="folder"></i>–ü–µ—Å–Ω–∏</button>
        <button class="nav-item" onclick="switchTab('team')"><i data-lucide="users"></i>–ö–æ–º–∞–Ω–¥–∞</button>
    </nav>
</div>

<script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π Supabase
    const { createClient } = window.supabase;

    // === –î–ê–ù–ù–´–ï –û–ë–õ–ê–ö–ê ===
    const PROJECT_URL = 'https://lbvwqkknabgxvgcields.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxidndxa2tuYWJneHZnY2llbGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTkzNDUsImV4cCI6MjA4Mzk5NTM0NX0.5Saze2DCH74pjUKUAdiFUdCx8bDmWmGF4nkbQwN4XF8';
    // =====================

    const worshipApp = createClient(PROJECT_URL, ANON_KEY);
    
    const ROLES = ["–ì–∏—Ç–∞—Ä–∞", "–ë–∞—Å", "–ë–∞—Ä–∞–±–∞–Ω—ã", "–ö–ª–∞–≤–∏—à–∏", "–í–æ–∫–∞–ª", "–ë—ç–∫-–≤–æ–∫–∞–ª"];
    let state = { services: [], songs: [], team: [] };
    let tempPlaylist = [];
    let cloudId = null;

    async function loadData() {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'block';
        
        try {
            const { data, error } = await worshipApp.from('app_state').select('*').limit(1).single();
            if (data) { 
                state = data.data; 
                cloudId = data.id; 
                renderUI(); 
            } else if (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                document.getElementById('list-services').innerText = "–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ.";
            }
        } catch (e) {
            console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", e);
        }
        
        if (loader) loader.style.display = 'none';
    }

    async function syncData() {
        if (cloudId) {
            await worshipApp.from('app_state').update({ data: state }).eq('id', cloudId);
        }
        renderUI();
    }

    worshipApp.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'app_state' }, payload => {
        if (payload.new) {
            state = payload.new.data; 
            renderUI();
        }
    }).subscribe();

    function renderUI() {
        const svcList = document.getElementById('list-services');
        if (svcList) {
            svcList.innerHTML = state.services.sort((a,b)=>a.day-b.day).map((s,i) => `
                <div class="card" onclick="openSvc(${i})">
                    <span class="leader-info">–õ–∏–¥–µ—Ä: ${s.leader} (${s.leaderInst})</span>
                    <div><b>${s.day} —è–Ω–≤</b> - ${s.type}</div>
                    <div style="margin-top:5px">${s.members.map(m=>`<span class="tag">${m.role}: ${m.name}</span>`).join('')}</div>
                    <div style="font-size:12px; color:gray; margin-top:5px">‚ô´ ${s.playlist.join(', ')}</div>
                    <button onclick="event.stopPropagation(); deleteSvc(${i})" style="position:absolute; top:10px; right:10px; border:none; background:none; color:red">√ó</button>
                </div>
            `).join('') || '–ì—Ä–∞—Ñ–∏–∫ –ø—É—Å—Ç';
        }

        const folderList = document.getElementById('list-folders');
        if (folderList) {
            folderList.innerHTML = state.team.map(m => `
                <div class="card" onclick="openFolder('${m.name}')">üìÅ <b>${m.name}</b> (${state.songs.filter(s=>s.owner===m.name).length} –ø–µ—Å–µ–Ω)</div>
            `).join('') || '–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –ö–æ–º–∞–Ω–¥—É';
        }

        const teamList = document.getElementById('list-team');
        if (teamList) { teamList.innerHTML = state.team.map((m,i) => `
            <div class="card">${m.name} <button onclick="deleteTeam(${i})" style="float:right; border:none; background:none; color:red">–£–¥–∞–ª–∏—Ç—å</button></div>
        `).join('') || '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç';
        }
        lucide.createIcons();
    }

    function switchTab(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        lucide.createIcons();
    }

    function openServiceForm() {
        tempPlaylist = [];
        const dates = []; for(let i=1; i<=31; i++) { const d=new Date(2026,0,i); if(d.getDay()===0||d.getDay()===2) dates.push({d:i, l:`${i} —è–Ω–≤ (${d.getDay()===0?'–í—Å':'–í—Ç'})`}); }
        showModal('–ù–æ–≤–æ–µ —Å–ª—É–∂–µ–Ω–∏–µ', `
            <label>–î–∞—Ç–∞</label><select id="sv_d">${dates.map(d=>`<option value="${d.d}">${d.l}</option>`).join('')}</select>
            <label>–õ–∏–¥–µ—Ä</label><select id="l1">${state.team.map(m=>`<option>${m.name}</option>`).join('') || '<option disabled>–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>'}</select>
            <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label><select id="l_i"><option>–í–æ–∫–∞–ª</option><option>–ì–∏—Ç–∞—Ä–∞</option></select>
            <label>–ü–µ—Å–Ω–∏: –ò–∑ —á—å–µ–π –ø–∞–ø–∫–∏?</label>
            <select onchange="renderSongPicker(this.value)"><option value="">-- –í—ã–±—Ä–∞—Ç—å --</option>${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <div id="picker-res" class="song-picker-box"></div>
            <button class="btn-submit" style="margin-top:10px" onclick="addSvc()">–°–æ–∑–¥–∞—Ç—å</button>
        `);
    }

    function renderSongPicker(owner) {
        const area = document.getElementById('picker-res');
        area.innerHTML = state.songs.filter(s=>s.owner===owner).map(s=>`
            <div class="song-item ${tempPlaylist.includes(s.title)?'selected':''}" onclick="tglS('${s.title}', this)">${s.title} <span>${s.key}</span></div>
        `).join('') || '–í –ø–∞–ø–∫–µ –ø—É—Å—Ç–æ';
    }

    function tglS(t, el) { 
        tempPlaylist.includes(t) ? tempPlaylist = tempPlaylist.filter(x=>x!==t) : tempPlaylist.push(t);
        el.classList.toggle('selected');
    }

    async function addSvc() {
        const d = document.getElementById('sv_d').value;
        const leader = document.getElementById('l1').value;
        if (!leader) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–¥–µ—Ä–∞!');
        state.services.push({ day: d, leader: leader, leaderInst: document.getElementById('l_i').value, type: new Date(2026,0,d).getDay()===0?'–í–æ—Å–∫—Ä–µ—Å–Ω–æ–µ':'–í—Ç–æ—Ä–Ω–∏–∫', playlist: [...tempPlaylist], members: [] });
        closeModal(); await syncData();
    }

    function openSvc(idx) {
        const s = state.services[idx];
        showModal('–î–µ—Ç–∞–ª–∏', `
            <button class="btn-submit" onclick="showJoin(${idx})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ —Å–æ—Å—Ç–∞–≤</button>
            <div style="margin-top:20px">${s.members.map((m,mi)=>`<div><b>${m.role}:</b> ${m.name} <button onclick="rmM(${idx},${mi})" style="color:red; border:none; background:none">√ó</button></div>`).join('') || '–°–æ—Å—Ç–∞–≤ –Ω–µ –Ω–∞–±—Ä–∞–Ω'}</div>
        `);
    }

    function showJoin(idx) {
        showModal('–ó–∞–ø–∏—Å—å', `
            <label>–ò–º—è</label><select id="j_n">${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <label>–†–æ–ª—å</label><select id="j_r">${ROLES.map(r=>`<option>${r}</option>`).join('')}</select>
            <button class="btn-submit" onclick="confirmJoin(${idx})">–ì–æ—Ç–æ–≤–æ</button>
        `);
    }

    async function confirmJoin(idx) { state.services[idx].members.push({name:document.getElementById('j_n').value, role:document.getElementById('j_r').value}); closeModal(); await syncData(); }
    async function rmM(idx, mi) { state.services[idx].members.splice(mi,1); await syncData(); openSvc(idx); }
    async function deleteSvc(idx) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { state.services.splice(idx,1); await syncData(); } }
    function openFolder(owner) {
        const songs = state.songs.filter(s=>s.owner===owner);
        showModal(`–ü–∞–ø–∫–∞: ${owner}`, `
            <button class="btn-submit" onclick="addSongPop('${owner}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Å–Ω—é</button>
            <div style="margin-top:15px">${songs.map(s=>`<div style="padding:8px 0; border-bottom:1px solid #eee"><b>${s.title}</b> [${s.key}] <button onclick="rmSong('${s.title}','${owner}')" style="float:right; color:red; border:none; background:none">√ó</button></div>`).join('') || '–ü–µ—Å–µ–Ω –Ω–µ—Ç'}</div>
        `);
    }
    function addSongPop(o) { showModal('–ù–æ–≤–∞—è –ø–µ—Å–Ω—è', `<label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="nt"><label>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label><input id="nk"><button class="btn-submit" onclick="confirmSong('${o}')">OK</button>`); }
    async function confirmSong(o) { const t=document.getElementById('nt').value; const k=document.getElementById('nk').value; if(t){ state.songs.push({title:t, key:k, owner:o}); await syncData(); openFolder(o); } }
    async function rmSong(t,o) { state.songs=state.songs.filter(s=>!(s.title===t && s.owner===o)); await syncData(); openFolder(o); }
    function openMemberForm() { showModal('–ö–æ–º–∞–Ω–¥–∞', `<input id="mn" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è"><button class="btn-submit" onclick="addM()">–î–æ–±–∞–≤–∏—Ç—å</button>`); }
    async function addM() { const n=document.getElementById('mn').value; if(n){state.team.push({name:n}); closeModal(); await syncData();} }
    async function deleteTeam(i) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { state.team.splice(i,1); await syncData(); } }
    function showModal(t, c) { document.getElementById('modal-title').innerText = t; document.getElementById('modal-content').innerHTML = c; document.getElementById('modal').style.display = 'block'; lucide.createIcons(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    loadData();
</script>
</body>
</html>