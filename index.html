<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Worship Pro Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            --p: #4f46e5; --bg: #f8fafc; --c: #ffffff; 
            --t: #0f172a; --m: #64748b; --d: #ef4444; --s: #10b981;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, system-ui, sans-serif; -webkit-tap-highlight-color:transparent; }
        
        body { 
            background: var(--bg); color: var(--t); 
            padding-bottom: env(safe-area-inset-bottom, 100px);
            line-height: 1.5; overflow-x: hidden;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 16px; width: 100%; }
        .screen { display: none; animation: fadeIn 0.2s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 20px 0; }
        h1 { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        
        .card { 
            background: var(--c); border-radius: 18px; padding: 18px; 
            margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.04); 
            position: relative; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.01);
        }
        .leader-badge { font-size: 11px; color: var(--p); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 0.5px; }
        .svc-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; padding-right: 30px; }
        
        .btn-add { 
            background: var(--p); color: white; border: none; width: 42px; height: 42px; 
            border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-submit { width: 100%; padding: 16px; background: var(--p); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; margin-top: 10px; }
        .btn-share { width: 100%; padding: 12px; background: var(--s); color: white; border: none; border-radius: 12px; font-weight: 700; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
        .btn-delete-item { 
            position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; 
            background: #fee2e2; color: var(--d); border-radius: 50%; border: none; cursor: pointer;
        }

        .tag { display: inline-block; padding: 5px 12px; background: #f1f5f9; border-radius: 10px; font-size: 12px; font-weight: 600; margin: 2px; color: var(--m); }
        .playlist-info { font-size: 13px; color: var(--m); margin-top: 10px; display: flex; align-items: center; gap: 6px; }

        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 16px; font-size: 16px; background: #fff; outline: none; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: var(--m); margin-left: 4px; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px 20px 100px 20px; overflow-y: auto; }

        .nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            width: 100%; max-width: 500px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.06); display: grid; grid-template-columns: 1fr 1fr 1fr;
            padding-top: 12px; padding-bottom: calc(14px + env(safe-area-inset-bottom, 20px)); z-index: 1000;
        }
        .nav-item { border: none; background: none; color: var(--m); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; gap: 4px; }
        .nav-item.active { color: var(--p); }
        .nav-item i { width: 24px; height: 24px; }

        .song-picker-box { border: 1px solid #e2e8f0; padding: 8px; border-radius: 12px; max-height: 200px; overflow-y: auto; background: #f8fafc; }
        .song-item { padding: 14px; border-radius: 10px; margin-bottom: 6px; background: white; border: 1px solid transparent; display: flex; justify-content: space-between; font-size: 14px; }
        .song-item.selected { background: #eef2ff; border-color: var(--p); color: var(--p); font-weight: 700; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: var(--p); display: none; z-index: 3000; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--m); font-size: 15px; }
    </style>
</head>
<body>

<div id="loader"></div>

<div class="container">
    <section id="schedule" class="screen active">
        <div class="header"><h1>–ì—Ä–∞—Ñ–∏–∫</h1><button class="btn-add" onclick="openServiceForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-services"></div>
    </section>

    <section id="songs" class="screen">
        <div class="header"><h1>–ü–µ—Å–Ω–∏</h1></div>
        <div id="list-folders"></div>
    </section>

    <section id="team" class="screen">
        <div class="header"><h1>–ö–æ–º–∞–Ω–¥–∞</h1><button class="btn-add" onclick="openMemberForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-team"></div>
    </section>

    <div id="modal">
        <div class="header"><h2 id="modal-title"></h2><button onclick="closeModal()" style="border:none; background:none; padding:10px;"><i data-lucide="x"></i></button></div>
        <div id="modal-content"></div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="switchTab('schedule', this)"><i data-lucide="calendar"></i>–ì—Ä–∞—Ñ–∏–∫</button>
        <button class="nav-item" onclick="switchTab('songs', this)"><i data-lucide="music"></i>–ü–µ—Å–Ω–∏</button>
        <button class="nav-item" onclick="switchTab('team', this)"><i data-lucide="users"></i>–ö–æ–º–∞–Ω–¥–∞</button>
    </nav>
</div>

<script>
    const PROJECT_URL = 'https://lbvwqkknabgxvgcields.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxidndxa2tuYWJneHZnY2llbGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTkzNDUsImV4cCI6MjA4Mzk5NTM0NX0.5Saze2DCH74pjUKUAdiFUdCx8bDmWmGF4nkbQwN4XF8';

    const { createClient } = window.supabase;
    const worshipApp = createClient(PROJECT_URL, ANON_KEY);
    
    const ROLES = ["–ì–∏—Ç–∞—Ä–∞", "–ë–∞—Å", "–ë–∞—Ä–∞–±–∞–Ω—ã", "–ö–ª–∞–≤–∏—à–∏", "–í–æ–∫–∞–ª", "–ë—ç–∫-–≤–æ–∫–∞–ª", "–ó–≤—É–∫", "–°–ª–∞–π–¥—ã"];
    let state = { services: [], songs: [], team: [] };
    let tempPlaylist = [];
    let cloudId = null;

    async function loadData() {
        showLoader(true);
        const { data } = await worshipApp.from('app_state').select('*').limit(1).single();
        if (data) { state = data.data; cloudId = data.id; renderUI(); }
        showLoader(false);
    }

    async function syncData() {
        if (!cloudId) return;
        showLoader(true);
        await worshipApp.from('app_state').update({ data: state }).eq('id', cloudId);
        showLoader(false);
        renderUI();
    }

    worshipApp.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'app_state' }, p => {
        if (p.new) { state = p.new.data; renderUI(); }
    }).subscribe();

    function renderUI() {
        const svcList = document.getElementById('list-services');
        if (svcList) {
            svcList.innerHTML = state.services.sort((a,b)=>a.day-b.day).map((s,i) => `
                <div class="card" onclick="openSvc(${i})">
                    <span class="leader-badge">${s.leader} ‚Ä¢ ${s.leaderInst}</span>
                    <div class="svc-title">${s.day} —è–Ω–≤–∞—Ä—è, ${s.type}</div>
                    <div style="margin: 4px -2px;">${s.members.map(m=>`<span class="tag">${m.role}: ${m.name}</span>`).join('')}</div>
                    <div class="playlist-info"><i data-lucide="music" style="width:14px"></i> ${s.playlist.length > 0 ? s.playlist.join(', ') : '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç'}</div>
                    <button class="btn-delete-item" onclick="event.stopPropagation(); deleteSvc(${i})">√ó</button>
                </div>
            `).join('') || '<div class="empty-state">–ì—Ä–∞—Ñ–∏–∫ –ø—É—Å—Ç</div>';
        }

        const folderList = document.getElementById('list-folders');
        if (folderList) {
            folderList.innerHTML = state.team.map(m => `
                <div class="card" onclick="openFolder('${m.name}')">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="background:#eef2ff; color:var(--p); width:46px; height:46px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800;">${m.name[0]}</div>
                        <div><div style="font-weight:700;">${m.name}</div><div style="font-size:12px; color:var(--m);">${state.songs.filter(s=>s.owner===m.name).length} –ø–µ—Å–µ–Ω</div></div>
                    </div>
                </div>
            `).join('') || '<div class="empty-state">–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É</div>';
        }

        const teamList = document.getElementById('list-team');
        if (teamList) {
            teamList.innerHTML = state.team.map((m,i) => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:700;">${m.name}</div>
                    <button onclick="deleteTeam(${i})" style="color:var(--d); border:none; background:none; font-weight:700;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('') || '<div class="empty-state">–ö–æ–º–∞–Ω–¥–∞ –ø—É—Å—Ç–∞</div>';
        }
        lucide.createIcons();
    }

    function switchTab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        lucide.createIcons();
    }

    function openServiceForm() {
        tempPlaylist = [];
        const dates = []; for(let i=1; i<=31; i++) { const d=new Date(2026,0,i); if(d.getDay()===0||d.getDay()===2) dates.push({d:i, l:`${i} —è–Ω–≤ (${d.getDay()===0?'–í—Å':'–í—Ç'})`}); }
        showModal('–ù–æ–≤–æ–µ —Å–ª—É–∂–µ–Ω–∏–µ', `
            <label>–î–∞—Ç–∞</label><select id="sv_d">${dates.map(d=>`<option value="${d.d}">${d.l}</option>`).join('')}</select>
            <label>–õ–∏–¥–µ—Ä</label><select id="l1">${state.team.map(m=>`<option>${m.name}</option>`).join('') || '<option disabled>–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>'}</select>
            <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label><select id="l_i"><option>–í–æ–∫–∞–ª</option><option>–ì–∏—Ç–∞—Ä–∞</option><option>–ö–ª–∞–≤–∏—à–∏</option></select>
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –ø–µ—Å–Ω—è–º–∏:</label>
            <select onchange="renderSongPicker(this.value)"><option value="">-- –í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É --</option>${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <div id="picker-res" class="song-picker-box"></div>
            <button class="btn-submit" onclick="addSvc()">–°–æ–∑–¥–∞—Ç—å</button>
        `);
    }

    function renderSongPicker(owner) {
        const area = document.getElementById('picker-res');
        area.innerHTML = state.songs.filter(s=>s.owner===owner).map(s=>`
            <div class="song-item ${tempPlaylist.includes(s.title)?'selected':''}" onclick="tglS('${s.title}', this)">
                <span>${s.title}</span><span style="opacity:0.4">${s.key}</span>
            </div>
        `).join('') || '<div style="padding:20px; text-align:center;">–í –ø–∞–ø–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø–µ—Å–µ–Ω</div>';
    }

    function tglS(t, el) { 
        tempPlaylist.includes(t) ? tempPlaylist = tempPlaylist.filter(x=>x!==t) : tempPlaylist.push(t);
        el.classList.toggle('selected');
    }

    async function addSvc() {
        const d = document.getElementById('sv_d').value;
        const leader = document.getElementById('l1').value;
        if(!leader) return;
        state.services.push({ day: d, leader: leader, leaderInst: document.getElementById('l_i').value, type: new Date(2026,0,d).getDay()===0?'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ':'–í—Ç–æ—Ä–Ω–∏–∫', playlist: [...tempPlaylist], members: [] });
        closeModal(); await syncData();
    }

    function openSvc(idx) {
        const s = state.services[idx];
        showModal('–î–µ—Ç–∞–ª–∏ —Å–ª—É–∂–µ–Ω–∏—è', `
            <div style="background:#f1f5f9; padding:18px; border-radius:14px; margin-bottom:15px;">
                <div style="font-size:12px; font-weight:700; color:var(--m); margin-bottom:6px;">–ü–ª–µ–π–ª–∏—Å—Ç:</div>
                <div style="font-weight:700;">${s.playlist.join(', ') || '–ü–µ—Å–Ω–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã'}</div>
            </div>
            <button class="btn-submit" onclick="showJoin(${idx})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ —Å–æ—Å—Ç–∞–≤</button>
            <button class="btn-share" onclick="shareWp(${idx})"><i data-lucide="share-2" style="width:18px"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ WhatsApp</button>
            <div style="margin-top:20px;">
                <label>–¢–µ–∫—É—â–∏–π —Å–æ—Å—Ç–∞–≤:</label>
                ${s.members.map((m,mi)=>`
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f1f5f9;">
                        <div><b>${m.role}:</b> ${m.name}</div>
                        <button onclick="rmM(${idx},${mi})" style="color:var(--d); border:none; background:none; font-size:20px;">√ó</button>
                    </div>
                `).join('') || '<div style="color:gray; font-size:14px;">–ù–∏–∫—Ç–æ –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è</div>'}
            </div>
        `);
    }

    function shareWp(idx) {
        const s = state.services[idx];
        let text = `üìÖ *–ü–ª–∞–Ω –Ω–∞ ${s.day} —è–Ω–≤–∞—Ä—è (${s.type})*\n\n`;
        text += `üë§ *–õ–∏–¥–µ—Ä:* ${s.leader}\n`;
        text += `üéµ *–ü–µ—Å–Ω–∏:* ${s.playlist.join(', ') || '–Ω–µ –≤—ã–±—Ä–∞–Ω—ã'}\n\n`;
        text += `üë• *–°–æ—Å—Ç–∞–≤:* \n`;
        s.members.forEach(m => text += `‚Ä¢ ${m.role}: ${m.name}\n`);
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
    }

    function showJoin(idx) {
        showModal('–ó–∞–ø–∏—Å—å', `
            <label>–ò–º—è</label><select id="j_n">${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <label>–†–æ–ª—å</label><select id="j_r">${ROLES.map(r=>`<option>${r}</option>`).join('')}</select>
            <button class="btn-submit" onclick="confirmJoin(${idx})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
        `);
    }

    async function confirmJoin(idx) { state.services[idx].members.push({name:document.getElementById('j_n').value, role:document.getElementById('j_r').value}); closeModal(); await syncData(); }
    async function rmM(idx, mi) { state.services[idx].members.splice(mi,1); await syncData(); openSvc(idx); }
    async function deleteSvc(idx) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { state.services.splice(idx,1); await syncData(); } }
    
    function openFolder(owner) {
        const songs = state.songs.filter(s=>s.owner===owner);
        showModal(`–ü–∞–ø–∫–∞: ${owner}`, `
            <button class="btn-submit" style="margin-bottom:15px" onclick="addSongPop('${owner}')">+ –ù–æ–≤–∞—è –ø–µ—Å–Ω—è</button>
            <div>${songs.length > 0 ? songs.map(s=>`
                <div style="display:flex; justify-content:space-between; padding:16px; background:#f8fafc; border-radius:12px; margin-bottom:8px; border:1px solid #f1f5f9;">
                    <div><b>${s.title}</b> <span style="color:var(--m); font-size:13px;">[${s.key}]</span></div>
                    <button onclick="rmSong('${s.title}','${owner}')" style="color:var(--d); border:none; background:none; font-size:18px;">√ó</button>
                </div>`).join('') : `
                <div class="empty-state" style="padding:20px;">
                    <p>–í –ø–∞–ø–∫–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ</p>
                    <button class="btn-submit" style="background:none; color:var(--p); border:1px solid var(--p); margin-top:10px;" onclick="addSongPop('${owner}')">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –ø–µ—Å–Ω—é</button>
                </div>
            `}</div>
        `);
    }

    function addSongPop(o) { showModal('–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Å–Ω—é', `<label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="nt"><label>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label><input id="nk"><button class="btn-submit" onclick="confirmSong('${o}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`); }
    async function confirmSong(o) { const t=document.getElementById('nt').value; const k=document.getElementById('nk').value; if(t){ state.songs.push({title:t, key:k, owner:o}); await syncData(); openFolder(o); } }
    async function rmSong(t,o) { state.songs=state.songs.filter(s=>!(s.title===t && s.owner===o)); await syncData(); openFolder(o); }
    
    function openMemberForm() { showModal('–ö–æ–º–∞–Ω–¥–∞', `<label>–ò–º—è</label><input id="mn"><button class="btn-submit" onclick="addM()">–î–æ–±–∞–≤–∏—Ç—å</button>`); }
    async function addM() { const n=document.getElementById('mn').value; if(n){state.team.push({name:n}); closeModal(); await syncData();} }
    async function deleteTeam(i) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { state.team.splice(i,1); await syncData(); } }

    function showModal(t, c) { document.getElementById('modal-title').innerText = t; document.getElementById('modal-content').innerHTML = c; document.getElementById('modal').style.display = 'block'; lucide.createIcons(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'block' : 'none'; }
    
    loadData();
</script>
</body>
</html>