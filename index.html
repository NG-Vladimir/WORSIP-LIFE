<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Worship Pro Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --p: #4f46e5; --bg: #f8fafc; --c: #ffffff; --t: #0f172a; --m: #64748b; --d: #ef4444; --tg: #0088cc; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, system-ui, sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: var(--t); padding-bottom: 110px; line-height: 1.5; }
        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .screen { display: none; animation: fadeIn 0.2s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 20px 0; }
        h1 { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        .card { background: var(--c); border-radius: 18px; padding: 18px; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.04); position: relative; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.01); }
        .leader-badge { font-size: 11px; color: var(--p); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .svc-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; padding-right: 40px; }
        .btn-add { background: var(--p); color: white; border: none; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .btn-submit { width: 100%; padding: 16px; background: var(--p); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; margin-top: 10px; }
        .btn-tg { width: 100%; padding: 12px; background: var(--tg); color: white; border: none; border-radius: 12px; font-weight: 700; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-edit { width: 100%; padding: 10px; background: #f1f5f9; color: var(--m); border: 1px solid #e2e8f0; border-radius: 12px; font-weight: 600; font-size: 14px; margin-top: 8px; }
        .btn-delete-item { position: absolute; top: 12px; right: 12px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; background: #fee2e2; color: var(--d); border-radius: 50%; border: none; }
        .tag { display: inline-block; padding: 5px 12px; background: #f1f5f9; border-radius: 10px; font-size: 12px; font-weight: 600; margin: 2px; color: var(--m); }
        input, select, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 16px; font-size: 16px; background: #fff; outline: none; }
        textarea { height: 150px; font-family: monospace; font-size: 14px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: var(--m); margin-left: 4px; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px 20px 100px 20px; overflow-y: auto; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 500px; margin: 0 auto; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.06); display: grid; grid-template-columns: 1fr 1fr 1fr; padding-top: 12px; padding-bottom: calc(14px + env(safe-area-inset-bottom, 20px)); z-index: 1000; }
        .nav-item { border: none; background: none; color: var(--m); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; gap: 4px; }
        .nav-item.active { color: var(--p); }
        .nav-item i { width: 24px; height: 24px; }
        .song-picker-box { border: 1px solid #e2e8f0; padding: 8px; border-radius: 12px; max-height: 200px; overflow-y: auto; background: #f8fafc; }
        .song-item { padding: 12px; border-radius: 10px; margin-bottom: 6px; background: white; border: 1px solid transparent; display: flex; justify-content: space-between; font-size: 14px; }
        .song-item.selected { background: #eef2ff; border-color: var(--p); color: var(--p); font-weight: 700; }
        .lyrics-pre { white-space: pre-wrap; background: #f8fafc; padding: 15px; border-radius: 12px; font-family: 'Courier New', monospace; font-size: 14px; border: 1px solid #eee; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: var(--p); display: none; z-index: 3000; }
    </style>
</head>
<body>

<div id="loader"></div>

<div class="container">
    <section id="schedule" class="screen active">
        <div class="header"><h1>–ì—Ä–∞—Ñ–∏–∫</h1><button class="btn-add" onclick="openServiceForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-services"></div>
    </section>

    <section id="songs" class="screen">
        <div class="header"><h1>–ü–µ—Å–Ω–∏</h1></div>
        <div id="list-folders"></div>
    </section>

    <section id="team" class="screen">
        <div class="header"><h1>–ö–æ–º–∞–Ω–¥–∞</h1><button class="btn-add" onclick="openMemberForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-team"></div>
    </section>

    <div id="modal">
        <div class="header"><h2 id="modal-title"></h2><button onclick="closeModal()" style="border:none; background:none; padding:10px;"><i data-lucide="x"></i></button></div>
        <div id="modal-content"></div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="switchTab('schedule', this)"><i data-lucide="calendar"></i>–ì—Ä–∞—Ñ–∏–∫</button>
        <button class="nav-item" onclick="switchTab('songs', this)"><i data-lucide="music"></i>–ü–µ—Å–Ω–∏</button>
        <button class="nav-item" onclick="switchTab('team', this)"><i data-lucide="users"></i>–ö–æ–º–∞–Ω–¥–∞</button>
    </nav>
</div>

<script>
    const PROJECT_URL = 'https://lbvwqkknabgxvgcields.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxidndxa2tuYWJneHZnY2llbGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTkzNDUsImV4cCI6MjA4Mzk5NTM0NX0.5Saze2DCH74pjUKUAdiFUdCx8bDmWmGF4nkbQwN4XF8';

    const { createClient } = window.supabase;
    const worshipApp = createClient(PROJECT_URL, ANON_KEY);
    
    const ROLES = ["–ì–∏—Ç–∞—Ä–∞", "–ë–∞—Å", "–ë–∞—Ä–∞–±–∞–Ω—ã", "–ö–ª–∞–≤–∏—à–∏", "–í–æ–∫–∞–ª", "–ë—ç–∫-–≤–æ–∫–∞–ª", "–ó–≤—É–∫", "–°–ª–∞–π–¥—ã"];
    const INSTS = ["–ì–∏—Ç–∞—Ä–∞ + –í–æ–∫–∞–ª", "–í–æ–∫–∞–ª", "–ì–∏—Ç–∞—Ä–∞", "–ö–ª–∞–≤–∏—à–∏", "–ë–∞—Å"];
    let state = { services: [], songs: [], team: [] };
    let tempPlaylist = [];
    let cloudId = null;

    async function loadData() {
        showLoader(true);
        const { data } = await worshipApp.from('app_state').select('*').limit(1).single();
        if (data) { state = data.data; cloudId = data.id; renderUI(); }
        showLoader(false);
    }

    async function syncData() {
        if (!cloudId) return;
        showLoader(true);
        await worshipApp.from('app_state').update({ data: state }).eq('id', cloudId);
        showLoader(false);
        renderUI();
    }

    worshipApp.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'app_state' }, p => {
        if (p.new) { state = p.new.data; renderUI(); }
    }).subscribe();

    function renderUI() {
        const svcList = document.getElementById('list-services');
        if (svcList) {
            svcList.innerHTML = state.services.sort((a,b)=>a.day-b.day).map((s,i) => `
                <div class="card" onclick="openSvc(${i})">
                    <span class="leader-badge">${s.leader} ‚Ä¢ ${s.leaderInst}</span>
                    <div class="svc-title">${s.day} —è–Ω–≤–∞—Ä—è, ${s.type}</div>
                    <div>${s.members.map(m=>`<span class="tag">${m.role}: ${m.name}</span>`).join('')}</div>
                    <div style="font-size:13px; color:var(--m); margin-top:8px;">‚ô´ ${s.playlist.join(', ') || '–ù–µ—Ç –ø–µ—Å–µ–Ω'}</div>
                    <button class="btn-delete-item" onclick="event.stopPropagation(); deleteSvc(${i})">√ó</button>
                </div>
            `).join('') || '<div class="empty-state">–ì—Ä–∞—Ñ–∏–∫ –ø—É—Å—Ç</div>';
        }

        const folderList = document.getElementById('list-folders');
        if (folderList) {
            folderList.innerHTML = state.team.map(m => `
                <div class="card" onclick="openFolder('${m.name}')">
                    <div style="font-weight:700;">üìÅ ${m.name}</div>
                    <div style="font-size:12px; color:var(--m);">${state.songs.filter(s=>s.owner===m.name).length} –ø–µ—Å–µ–Ω</div>
                </div>
            `).join('') || '<div class="empty-state">–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É</div>';
        }

        const teamList = document.getElementById('list-team');
        if (teamList) {
            teamList.innerHTML = state.team.map((m,i) => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <b>${m.name}</b>
                    <button onclick="deleteTeam(${i})" style="color:var(--d); border:none; background:none; font-weight:700;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('') || '<div class="empty-state">–ö–æ–º–∞–Ω–¥–∞ –ø—É—Å—Ç–∞</div>';
        }
        lucide.createIcons();
    }

    function switchTab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        lucide.createIcons();
    }

    function openServiceForm(editIdx = null) {
        tempPlaylist = editIdx !== null ? [...state.services[editIdx].playlist] : [];
        const s = editIdx !== null ? state.services[editIdx] : null;
        const dates = []; for(let i=1; i<=31; i++) { const d=new Date(2026,0,i); if(d.getDay()===0||d.getDay()===2) dates.push({d:i, l:`${i} —è–Ω–≤ (${d.getDay()===0?'–í—Å':'–í—Ç'})`}); }
        
        showModal(editIdx !== null ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–æ–µ —Å–ª—É–∂–µ–Ω–∏–µ', `
            <label>–î–∞—Ç–∞</label><select id="sv_d">${dates.map(d=>`<option value="${d.d}" ${s && s.day==d.d?'selected':''}>${d.l}</option>`).join('')}</select>
            <label>–õ–∏–¥–µ—Ä</label><select id="l1">${state.team.map(m=>`<option ${s && s.leader==m.name?'selected':''}>${m.name}</option>`).join('')}</select>
            <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label><select id="l_i">${INSTS.map(ins=>`<option ${s && s.leaderInst==ins?'selected':''}>${ins}</option>`).join('')}</select>
            <label>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Å–Ω–∏ –∏–∑ –ø–∞–ø–∫–∏:</label>
            <select onchange="renderSongPicker(this.value)"><option value="">-- –í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É --</option>${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <div id="picker-res" class="song-picker-box"></div>
            <button class="btn-submit" onclick="saveSvc(${editIdx})">${editIdx !== null ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫'}</button>
        `);
    }

    function renderSongPicker(owner) {
        const area = document.getElementById('picker-res');
        area.innerHTML = state.songs.filter(s=>s.owner===owner).map(s=>`
            <div class="song-item ${tempPlaylist.includes(s.title)?'selected':''}" onclick="tglS('${s.title}', this)">
                <span>${s.title}</span><span style="opacity:0.4">${s.key}</span>
            </div>
        `).join('') || '<div style="padding:15px; text-align:center;">–ü—É—Å—Ç–æ</div>';
    }

    function tglS(t, el) { 
        tempPlaylist.includes(t) ? tempPlaylist = tempPlaylist.filter(x=>x!==t) : tempPlaylist.push(t);
        el.classList.toggle('selected');
    }

    async function saveSvc(idx) {
        const d = document.getElementById('sv_d').value;
        const leader = document.getElementById('l1').value;
        const obj = { 
            day: d, leader: leader, leaderInst: document.getElementById('l_i').value, 
            type: new Date(2026,0,d).getDay()===0?'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ':'–í—Ç–æ—Ä–Ω–∏–∫', 
            playlist: [...tempPlaylist], 
            members: idx !== null ? state.services[idx].members : [] 
        };
        if(idx !== null) state.services[idx] = obj; else state.services.push(obj);
        closeModal(); await syncData();
    }

    function openSvc(idx) {
        const s = state.services[idx];
        showModal('–î–µ—Ç–∞–ª–∏', `
            <div style="background:#f1f5f9; padding:15px; border-radius:14px; margin-bottom:15px;">
                <div style="font-size:12px; font-weight:700; color:var(--m); margin-bottom:5px;">–ü–ï–°–ù–ò:</div>
                ${s.playlist.map(p => `<div onclick="viewSong('${p}')" style="color:var(--p); font-weight:700; padding:5px 0; text-decoration:underline;">${p}</div>`).join('') || '–ù–µ –≤—ã–±—Ä–∞–Ω—ã'}
            </div>
            <button class="btn-submit" onclick="showJoin(${idx})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ —Å–æ—Å—Ç–∞–≤</button>
            <button class="btn-edit" onclick="openServiceForm(${idx})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>
            <button class="btn-tg" onclick="shareTg(${idx})">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram</button>
            <div style="margin-top:20px;">
                <label>–°–æ—Å—Ç–∞–≤:</label>
                ${s.members.map((m,mi)=>`<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;"><div><b>${m.role}:</b> ${m.name}</div><button onclick="rmM(${idx},${mi})" style="color:var(--d); border:none; background:none;">√ó</button></div>`).join('') || '–ü—É—Å—Ç–æ'}
            </div>
        `);
    }

    function viewSong(title) {
        const song = state.songs.find(s => s.title === title);
        if(!song) return;
        showModal(song.title, `
            <label>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: ${song.key}</label>
            <div class="lyrics-pre">${song.lyrics || '–¢–µ–∫—Å—Ç –∏ –∞–∫–∫–æ—Ä–¥—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã'}</div>
            <button class="btn-submit" style="background:var(--m)" onclick="openFolder('${song.owner}')">–ù–∞–∑–∞–¥ –≤ –ø–∞–ø–∫—É</button>
        `);
    }

    function shareTg(idx) {
        const s = state.services[idx];
        let text = `üìÖ *–ü–ª–∞–Ω –Ω–∞ ${s.day} —è–Ω–≤–∞—Ä—è (${s.type})*\n\n`;
        text += `üë§ *–õ–∏–¥–µ—Ä:* ${s.leader} (${s.leaderInst})\n`;
        text += `üéµ *–ü–µ—Å–Ω–∏:* ${s.playlist.join(', ') || '–Ω–µ—Ç'}\n\n`;
        text += `üë• *–°–æ—Å—Ç–∞–≤:* \n`;
        s.members.forEach(m => text += `‚Ä¢ ${m.role}: ${m.name}\n`);
        window.open(`https://t.me/share/url?url=${encodeURIComponent(text)}`);
    }

    function showJoin(idx) {
        showModal('–ó–∞–ø–∏—Å—å', `
            <label>–ò–º—è</label><select id="j_n">${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <label>–†–æ–ª—å</label><select id="j_r">${ROLES.map(r=>`<option>${r}</option>`).join('')}</select>
            <button class="btn-submit" onclick="confirmJoin(${idx})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
        `);
    }

    async function confirmJoin(idx) { state.services[idx].members.push({name:document.getElementById('j_n').value, role:document.getElementById('j_r').value}); closeModal(); await syncData(); }
    async function rmM(idx, mi) { state.services[idx].members.splice(mi,1); await syncData(); openSvc(idx); }
    async function deleteSvc(idx) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { state.services.splice(idx,1); await syncData(); } }
    
    function openFolder(owner) {
        const songs = state.songs.filter(s=>s.owner===owner);
        showModal(`–ü–∞–ø–∫–∞: ${owner}`, `
            <button class="btn-submit" style="margin-bottom:15px" onclick="addSongPop('${owner}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Å–Ω—é</button>
            <div>${songs.map(s=>`
                <div class="card" onclick="viewSong('${s.title}')">
                    <b>${s.title}</b> [${s.key}]
                    <button onclick="event.stopPropagation(); rmSong('${s.title}','${owner}')" style="position:absolute; top:12px; right:12px; color:var(--d); border:none; background:none;">√ó</button>
                </div>`).join('') || '–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞'}</div>
        `);
    }

    function addSongPop(o) { showModal('–ù–æ–≤–∞—è –ø–µ—Å–Ω—è', `
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="nt">
        <label>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</label><input id="nk">
        <label>–ê–∫–∫–æ—Ä–¥—ã –∏ —Ç–µ–∫—Å—Ç</label><textarea id="nl" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –∞–∫–∫–æ—Ä–¥—ã..."></textarea>
        <button class="btn-submit" onclick="confirmSong('${o}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    `); }

    async function confirmSong(o) { 
        const t=document.getElementById('nt').value;
        if(t){ state.songs.push({title:t, key:document.getElementById('nk').value, lyrics:document.getElementById('nl').value, owner:o}); await syncData(); openFolder(o); } 
    }
    
    async function rmSong(t,o) { state.songs=state.songs.filter(s=>!(s.title===t && s.owner===o)); await syncData(); openFolder(o); }
    function openMemberForm() { showModal('–ö–æ–º–∞–Ω–¥–∞', `<label>–ò–º—è</label><input id="mn"><button class="btn-submit" onclick="addM()">–î–æ–±–∞–≤–∏—Ç—å</button>`); }
    async function addM() { const n=document.getElementById('mn').value; if(n){state.team.push({name:n}); closeModal(); await syncData();} }
    async function deleteTeam(i) { if(confirm("–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?")) { state.team.splice(i,1); await syncData(); } }
    function showModal(t, c) { document.getElementById('modal-title').innerText = t; document.getElementById('modal-content').innerHTML = c; document.getElementById('modal').style.display = 'block'; lucide.createIcons(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'block' : 'none'; }
    loadData();
</script>
</body>
</html>