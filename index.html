<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Worship Pro Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            --p: #4f46e5; --bg: #f8fafc; --c: #ffffff; 
            --t: #0f172a; --m: #64748b; --d: #ef4444; 
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, system-ui, sans-serif; -webkit-tap-highlight-color:transparent; }
        
        body { 
            background: var(--bg); color: var(--t); 
            padding-bottom: env(safe-area-inset-bottom, 100px);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 16px; width: 100%; }
        .screen { display: none; animation: fadeIn 0.2s ease; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Шапка */
        .header { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 20px 0; }
        h1 { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        
        /* Карточки */
        .card { 
            background: var(--c); border-radius: 18px; padding: 18px; 
            margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.04); 
            position: relative; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.01);
        }
        .leader-badge { font-size: 11px; color: var(--p); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 0.5px; }
        .svc-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--t); }
        
        /* Кнопки */
        .btn-add { 
            background: var(--p); color: white; border: none; width: 42px; height: 42px; 
            border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .btn-submit { width: 100%; padding: 16px; background: var(--p); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; margin-top: 10px; }
        
        /* Теги */
        .tag { display: inline-block; padding: 5px 12px; background: #f1f5f9; border-radius: 10px; font-size: 12px; font-weight: 600; margin: 2px; color: var(--m); }
        .playlist-info { font-size: 13px; color: var(--m); margin-top: 10px; display: flex; align-items: center; gap: 6px; font-style: italic; }

        /* Инпуты */
        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 16px; font-size: 16px; background: #fff; appearance: none; outline: none; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: var(--m); margin-left: 4px; }

        /* Модалка */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; overflow-y: auto; }

        /* НИЖНЕЕ МЕНЮ - ТЕПЕРЬ СИММЕТРИЧНОЕ */
        .nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            width: 100%; max-width: 500px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.06); 
            display: grid; grid-template-columns: 1fr 1fr 1fr; /* Ровно 3 колонки */
            padding-top: 12px;
            padding-bottom: calc(14px + env(safe-area-inset-bottom, 20px)); /* Умный отступ для iPhone */
            z-index: 1000;
        }
        .nav-item { 
            border: none; background: none; color: var(--m); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; gap: 4px;
            text-decoration: none; transition: color 0.2s;
        }
        .nav-item.active { color: var(--p); }
        .nav-item i { width: 24px; height: 24px; }

        .song-picker-box { border: 1px solid #e2e8f0; padding: 8px; border-radius: 12px; max-height: 200px; overflow-y: auto; background: #f8fafc; }
        .song-item { padding: 14px; border-radius: 10px; margin-bottom: 6px; background: white; border: 1px solid transparent; display: flex; justify-content: space-between; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .song-item.selected { background: #eef2ff; border-color: var(--p); color: var(--p); font-weight: 700; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: var(--p); display: none; z-index: 3000; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--m); font-size: 15px; }
    </style>
</head>
<body>

<div id="loader"></div>

<div class="container">
    <section id="schedule" class="screen active">
        <div class="header"><h1>График</h1><button class="btn-add" onclick="openServiceForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-services"></div>
    </section>

    <section id="songs" class="screen">
        <div class="header"><h1>Песни</h1></div>
        <div id="list-folders"></div>
    </section>

    <section id="team" class="screen">
        <div class="header"><h1>Команда</h1><button class="btn-add" onclick="openMemberForm()"><i data-lucide="plus"></i></button></div>
        <div id="list-team"></div>
    </section>

    <div id="modal">
        <div class="header"><h2 id="modal-title"></h2><button onclick="closeModal()" style="border:none; background:none; padding:10px;"><i data-lucide="x"></i></button></div>
        <div id="modal-content"></div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="switchTab('schedule', this)"><i data-lucide="calendar"></i>График</button>
        <button class="nav-item" onclick="switchTab('songs', this)"><i data-lucide="music"></i>Песни</button>
        <button class="nav-item" onclick="switchTab('team', this)"><i data-lucide="users"></i>Команда</button>
    </nav>
</div>

<script>
    // === ДАННЫЕ ОБЛАКА ===
    const PROJECT_URL = 'https://lbvwqkknabgxvgcields.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxidndxa2tuYWJneHZnY2llbGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTkzNDUsImV4cCI6MjA4Mzk5NTM0NX0.5Saze2DCH74pjUKUAdiFUdCx8bDmWmGF4nkbQwN4XF8';
    // =====================

    const { createClient } = window.supabase;
    const worshipApp = createClient(PROJECT_URL, ANON_KEY);
    
    const ROLES = ["Гитара", "Бас", "Барабаны", "Клавиши", "Вокал", "Бэк-вокал", "Звук", "Слайды"];
    let state = { services: [], songs: [], team: [] };
    let tempPlaylist = [];
    let cloudId = null;

    async function loadData() {
        showLoader(true);
        const { data } = await worshipApp.from('app_state').select('*').limit(1).single();
        if (data) { state = data.data; cloudId = data.id; renderUI(); }
        showLoader(false);
    }

    async function syncData() {
        if (!cloudId) return;
        showLoader(true);
        await worshipApp.from('app_state').update({ data: state }).eq('id', cloudId);
        showLoader(false);
        renderUI();
    }

    worshipApp.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'app_state' }, payload => {
        if (payload.new) { state = payload.new.data; renderUI(); }
    }).subscribe();

    function renderUI() {
        const svcList = document.getElementById('list-services');
        if (svcList) {
            svcList.innerHTML = state.services.sort((a,b)=>a.day-b.day).map((s,i) => `
                <div class="card" onclick="openSvc(${i})">
                    <span class="leader-badge">${s.leader} • ${s.leaderInst}</span>
                    <div class="svc-title">${s.day} января, ${s.type}</div>
                    <div style="margin: 4px -2px;">${s.members.map(m=>`<span class="tag">${m.role}: ${m.name}</span>`).join('')}</div>
                    <div class="playlist-info"><i data-lucide="music" style="width:14px"></i> ${s.playlist.length > 0 ? s.playlist.join(', ') : 'Список песен не составлен'}</div>
                    <button onclick="event.stopPropagation(); deleteSvc(${i})" style="position:absolute; top:18px; right:18px; border:none; background:none; color:var(--m); opacity:0.3; font-size:20px;">×</button>
                </div>
            `).join('') || '<div class="empty-state">Пока ничего не запланировано.<br>Нажмите +, чтобы добавить.</div>';
        }

        const folderList = document.getElementById('list-folders');
        if (folderList) {
            folderList.innerHTML = state.team.map(m => `
                <div class="card" onclick="openFolder('${m.name}')">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="background:linear-gradient(135deg, #eef2ff, #e0e7ff); color:var(--p); width:46px; height:46px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:18px;">${m.name[0]}</div>
                        <div>
                            <div style="font-weight:700; font-size:16px;">${m.name}</div>
                            <div style="font-size:12px; color:var(--m);">Песен в папке: ${state.songs.filter(s=>s.owner===m.name).length}</div>
                        </div>
                    </div>
                </div>
            `).join('') || '<div class="empty-state">Добавьте участников во вкладке "Команда"</div>';
        }

        const teamList = document.getElementById('list-team');
        if (teamList) {
            teamList.innerHTML = state.team.map((m,i) => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:14px 18px;">
                    <div style="font-weight:700;">${m.name}</div>
                    <button onclick="deleteTeam(${i})" style="padding:6px; color:var(--d); border:none; background:none; font-weight:700; font-size:13px;">Удалить</button>
                </div>
            `).join('') || '<div class="empty-state">Список команды пуст.</div>';
        }
        lucide.createIcons();
    }

    function switchTab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        lucide.createIcons();
    }

    function openServiceForm() {
        tempPlaylist = [];
        const dates = []; for(let i=1; i<=31; i++) { const d=new Date(2026,0,i); if(d.getDay()===0||d.getDay()===2) dates.push({d:i, l:`${i} янв (${d.getDay()===0?'Вс':'Вт'})`}); }
        showModal('Новое служение', `
            <label>Дата</label><select id="sv_d">${dates.map(d=>`<option value="${d.d}">${d.l}</option>`).join('')}</select>
            <label>Лидер</label><select id="l1">${state.team.map(m=>`<option>${m.name}</option>`).join('') || '<option disabled>Добавьте участников</option>'}</select>
            <label>Инструмент лидера</label><select id="l_i"><option>Вокал</option><option>Гитара</option><option>Клавиши</option></select>
            <label>Выберите песни из папки:</label>
            <select onchange="renderSongPicker(this.value)"><option value="">-- Выбрать папку --</option>${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <div id="picker-res" class="song-picker-box"></div>
            <button class="btn-submit" onclick="addSvc()">Создать</button>
        `);
    }

    function renderSongPicker(owner) {
        const area = document.getElementById('picker-res');
        area.innerHTML = state.songs.filter(s=>s.owner===owner).map(s=>`
            <div class="song-item ${tempPlaylist.includes(s.title)?'selected':''}" onclick="tglS('${s.title}', this)">
                <span>${s.title}</span><span style="opacity:0.4; font-weight:400;">${s.key}</span>
            </div>
        `).join('') || '<div style="padding:20px; text-align:center; font-size:13px; color:gray;">Папка пуста</div>';
    }

    function tglS(t, el) { 
        tempPlaylist.includes(t) ? tempPlaylist = tempPlaylist.filter(x=>x!==t) : tempPlaylist.push(t);
        el.classList.toggle('selected');
    }

    async function addSvc() {
        const d = document.getElementById('sv_d').value;
        const leader = document.getElementById('l1').value;
        if(!leader) return;
        state.services.push({ day: d, leader: leader, leaderInst: document.getElementById('l_i').value, type: new Date(2026,0,d).getDay()===0?'Воскресенье':'Вторник', playlist: [...tempPlaylist], members: [] });
        closeModal(); await syncData();
    }

    function openSvc(idx) {
        const s = state.services[idx];
        showModal('Детали служения', `
            <div style="background:#f1f5f9; padding:18px; border-radius:14px; margin-bottom:15px;">
                <div style="font-size:12px; color:var(--m); font-weight:700; text-transform:uppercase; margin-bottom:6px;">Плейлист:</div>
                <div style="font-weight:700; font-size:15px; color:var(--t);">${s.playlist.join(', ') || 'Песни не выбраны'}</div>
            </div>
            <button class="btn-submit" onclick="showJoin(${idx})">Записаться в состав</button>
            <div style="margin-top:20px;">
                <label>Текущий состав:</label>
                ${s.members.map((m,mi)=>`
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 0; border-bottom:1px solid #f1f5f9;">
                        <div><b style="color:var(--p)">${m.role}:</b> ${m.name}</div>
                        <button onclick="rmM(${idx},${mi})" style="color:var(--d); border:none; background:none; font-size:22px; padding:0 10px;">×</button>
                    </div>
                `).join('') || '<div style="color:gray; font-size:14px; padding:10px 0;">Никто еще не записался</div>'}
            </div>
        `);
    }

    function showJoin(idx) {
        showModal('Запись', `
            <label>Имя</label><select id="j_n">${state.team.map(m=>`<option>${m.name}</option>`).join('')}</select>
            <label>Роль</label><select id="j_r">${ROLES.map(r=>`<option>${r}</option>`).join('')}</select>
            <button class="btn-submit" onclick="confirmJoin(${idx})">Записаться</button>
        `);
    }

    async function confirmJoin(idx) { state.services[idx].members.push({name:document.getElementById('j_n').value, role:document.getElementById('j_r').value}); closeModal(); await syncData(); }
    async function rmM(idx, mi) { state.services[idx].members.splice(mi,1); await syncData(); openSvc(idx); }
    async function deleteSvc(idx) { if(confirm("Удалить это служение?")) { state.services.splice(idx,1); await syncData(); } }
    
    function openFolder(owner) {
        const songs = state.songs.filter(s=>s.owner===owner);
        showModal(`Папка: ${owner}`, `
            <button class="btn-submit" style="margin-bottom:15px" onclick="addSongPop('${owner}')">+ Новая песня</button>
            <div>${songs.map(s=>`<div style="display:flex; justify-content:space-between; padding:16px; background:#f8fafc; border-radius:12px; margin-bottom:8px; border:1px solid #f1f5f9;"><div><b style="font-size:15px;">${s.title}</b> <span style="color:var(--m); font-size:13px;">[${s.key}]</span></div><button onclick="rmSong('${s.title}','${owner}')" style="color:var(--d); border:none; background:none; font-size:18px;">×</button></div>`).join('') || '<div style="text-align:center; padding:20px; color:gray;">Папка пуста</div>'}</div>
        `);
    }

    function addSongPop(o) { showModal('Добавить песню', `<label>Название</label><input id="nt" placeholder="Название песни"><label>Тональность</label><input id="nk" placeholder="Напр: G (Em)"><button class="btn-submit" onclick="confirmSong('${o}')">Сохранить</button>`); }
    async function confirmSong(o) { const t=document.getElementById('nt').value; const k=document.getElementById('nk').value; if(t){ state.songs.push({title:t, key:k, owner:o}); await syncData(); openFolder(o); } }
    async function rmSong(t,o) { state.songs=state.songs.filter(s=>!(s.title===t && s.owner===o)); await syncData(); openFolder(o); }
    
    function openMemberForm() { showModal('Команда', `<label>Имя и фамилия</label><input id="mn" placeholder="Иван Иванов"><button class="btn-submit" onclick="addM()">Добавить</button>`); }
    async function addM() { const n=document.getElementById('mn').value; if(n){state.team.push({name:n}); closeModal(); await syncData();} }
    async function deleteTeam(i) { if(confirm("Удалить участника?")) { state.team.splice(i,1); await syncData(); } }

    function showModal(t, c) { document.getElementById('modal-title').innerText = t; document.getElementById('modal-content').innerHTML = c; document.getElementById('modal').style.display = 'block'; lucide.createIcons(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'block' : 'none'; }
    
    loadData();
</script>
</body>
</html>